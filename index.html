<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shopping Cart</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.7.0.min.js"
      integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
      crossorigin="anonymous"
    ></script>
    <script src="
    https://cdn.jsdelivr.net/npm/sweetalert2@11.7.20/dist/sweetalert2.all.min.js
    "></script>
    <link rel="stylesheet" href="css/style2.css" />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <div
      class="modal fade"
      id="LoginModal"
      tabindex="-1"
      aria-labelledby="LoginModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="LoginModalLabel">Login Modal</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <input
              type="text"
              id="email"
              placeholder="Email"
              class="form-control mb-2"
              value="quypvpy@gmail.com"
            />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="submitloginBtn">
              Login
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- ===================================================== -->
    <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">Home</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-sm-0">
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Thương Hiệu
              </a>
              <ul
                class="dropdown-menu"
                aria-labelledby="navbarDropdown"
                id="brandUl"
              ></ul>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Loại sản phẩm
              </a>
              <ul
                class="dropdown-menu"
                aria-labelledby="navbarDropdown"
                id="cateUl"
              ></ul>
            </li>
            <li class="nav-item" id="billLi">
              <a href="/bills.html" class="nav-link">Hóa đơn</a>
            </li>
            <li class="nav-item" id="logoutLI">
              <a href="#" class="nav-link" id="logoutbtn">Logout</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="loginBtn">Login</a>
            </li>
          </ul>

          <form class="d-flex">
            <a class="icon-cart" href="/cart.html"
              ><i class="bx bxs-cart"></i
            ></a>
            <input
              class="form-control me-2"
              type="search"
              id="searchProduct"
              placeholder="Search"
              aria-label="Search"
            />
            <button class="btn btn-outline-success" id="searchBtn">
              Search
            </button>
          </form>
        </div>
      </div>
    </nav>
    <div class="carousel">
      <img src="https://shopdunk.com/images/uploaded/PC13.png" alt="" />
    </div>
    <div class="voucher">
      <div class="col">
        <img
          src="https://shopdunk.com/images/uploaded/Bonus%20banner-36.png"
          alt=""
        />
      </div>
      <div class="col">
        <img
          src="https://shopdunk.com/images/uploaded/Bonus%20banner-26.png"
          alt=""
        />
      </div>
      <div class="col">
        <img
          src="https://shopdunk.com/images/uploaded/Bonus%20banner-16.png"
          alt=""
        />
      </div>
    </div>
    <div style="width: 80%; margin: 10px auto">
      <h3 class="text-center">Sản Phẩm</h3>
      <hr />
      <div class="row" id="resultProduct"></div>
      <div class="row w-100 mt-3">
        <button
          style="margin: 10px auto"
          class="btn btn-outline-success w-25"
          id="showmorebtn"
        >
          Xem thêm
        </button>
      </div>
    </div>
    <footer className="w-100 py-4 flex-shrink-0">
      <div class="w-100 bg-dark text-light p-3">
        <div class="row">
          <div class="col-md">
            <div class="row">
              <h4 class="text-light text-center" style="padding-top: 10%">
                @ Phạm Văn Quỹ
              </h4>
            </div>
          </div>
          <div class="col-md-3">
            <iframe
              src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d7397.368957785469!2d106.81364439886346!3d10.840379293177014!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x31752731176b07b1%3A0xb752b24b379bae5e!2zVHLGsOG7nW5nIMSQ4bqhaSBo4buNYyBGUFQgVFAuIEhDTQ!5e0!3m2!1svi!2s!4v1691399952027!5m2!1svi!2s"
              width="100%"
              height="250px"
              style="border: 0"
              allowfullscreen=""
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
            ></iframe>
          </div>
        </div>
      </div>
    </footer>
    <script>
      $(document).ready(function () {
        login();
        loadData();
        showMore();
        logout();
        searchProducts();
      });
      const url = "https://students.trungthanhweb.com/api/";
      var link = url + "home"; //string
      // ===========Global Constant=============
      const Toast = Swal.mixin({
        toast: true,
        position: "top-end",
        showConfirmButton: false,
        timer: 1700,
        timerProgressBar: true,
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });
      function logout() {
        $("#logoutbtn").click(function (e) {
          e.preventDefault();
          if (localStorage.getItem("token")) {
            localStorage.removeItem("token");
            Toast.fire({
              icon: "success",
              title: "Bye bye !",
            }).then(() => {
              window.location.reload();
            });
          }
        });
      }
      //   ===============================
      function login() {
        $("#loginBtn").click(function (e) {
          e.preventDefault();
          $("#LoginModal").modal("show");
          $("#submitloginBtn").click(function (e) {
            e.preventDefault();
            var email = $("#email").val().trim();
            if (email == "") {
              Toast.fire({
                icon: "error",
                title: "Thiếu  email",
              });
            } else {
              $.ajax({
                type: "post",
                url: "https://students.trungthanhweb.com/api/checkLoginhtml",
                data: {
                  // Name : Giá trị
                  email: email,
                },
                dataType: "JSON",
                success: function (res) {
                  if (res.check == true) {
                    console.log(res.apitoken);
                    localStorage.setItem("token", res.apitoken);
                    Toast.fire({
                      icon: "success",
                      title: "Đăng nhập thành công",
                    }).then(() => {
                      window.location.reload();
                    });
                  } else {
                    if (res.msg.email) {
                      Toast.fire({
                        icon: "error",
                        title: res.msg.email,
                      });
                    }
                  }
                },
              });
            }
          });
        });
      }

      function searchProducts() {
        $("#searchBtn").click(function (e) {
          e.preventDefault();
          var name = $("#searchProduct").val().trim();
          if (name != "") {
            $.ajax({
              method: "GET",
              url: url + "getSearchProducts",
              data: {
                apitoken: localStorage.getItem("token"),
                name: name,
              },
              dataType: "JSON",
              success: function (res) {
                if (res.check == true) {
                  if (res.result.length > 0) {
                    var products = res.result;
                    var str = ``;
                    products.forEach((el) => {
                      str +=
                        `
                                <div class="col-md-3 mb-3">
                                    <div class="card" style="width: 100%;">
                                        <img class="productImage"  src="https://students.trungthanhweb.com/images/` +
                        el["image"] +
                        `">
                                        <div class="card-body">
                                            <a href="#">
                                            <h5 class="card-title">` +
                        el.name +
                        `</h5></a>
                                            <p class="card-text">
                                                Giá : ` +
                        Intl.NumberFormat("en-US").format(el.price) +
                        `    
                                            </p>
                                            <p>Loại sản phẩm : ` +
                        el.catename +
                        `</p>
                                            <p>Thương hiệu : ` +
                        el.brandname +
                        `</p>
                                            <a href="detail.html?id=` +
                        el.id +
                        `" class="btn btn-primary chitietBtn"
                                            data-id="` +
                        el.id +
                        `">Chi tiết</a>
                                            <button class="btn btn-success addToCartBtn" data-id=` +
                        el.id +
                        `>Thêm</button>
                                        </div>
                                    </div>
                                </div>
                                `;
                    });
                    $("#resultProduct").html(str);
                    $("#showmorebtn").hide();
                  } else {
                    var str = ``;
                    str += `<h4>Không có sản phẩm nào</h4>`;
                    $("#resultProduct").html(str);
                  }
                }
              },
            });
          } else {
            $.ajax({
              method: "GET",
              url: url + "getSearchProducts",
              data: {
                apitoken: localStorage.getItem("token"),
              },
              dataType: "JSON",
              success: function (res) {
                if (res.check == true) {
                  if (res.result.data.length > 0 && res.result.data) {
                    var products = res.result.data;
                    var str = ``;
                    products.forEach((el) => {
                      str +=
                        `
                                <div class="col-md-3 mb-3">
                                    <div class="card" style="width: 100%;">
                                        <img class="productImage"  src="https://students.trungthanhweb.com/images/` +
                        el["image"] +
                        `">
                                        <div class="card-body">
                                            <a href="#">
                                            <h5 class="card-title">` +
                        el.name +
                        `</h5></a>
                                            <p class="card-text">
                                                Giá : ` +
                        Intl.NumberFormat("en-US").format(el.price) +
                        `    
                                            </p>
                                            <p>Loại sản phẩm : ` +
                        el.catename +
                        `</p>
                                            <p>Thương hiệu : ` +
                        el.brandname +
                        `</p>
                                            <a href="detail.html?id=` +
                        el.id +
                        `" class="btn btn-primary chitietBtn"
                                            data-id="` +
                        el.id +
                        `">Chi tiết</a>
                                            <button class="btn btn-success addToCartBtn" data-id=` +
                        el.id +
                        `>Thêm</button>
                                        </div>
                                    </div>
                                </div>
                                `;
                    });
                    $("#resultProduct").html(str);
                    $("#showmorebtn").show();
                  }
                }
              },
            });
          }
        });
      }

      // ================================

      // ================================
      function loadData() {
        $("#logoutbtn").hide();
        if (
          localStorage.getItem("token") &&
          localStorage.getItem("token") != null
        ) {
          $("#loginBtn").hide();
          $("#logoutbtn").show();
          $("#showmorebtn").click(function (e) {
            e.preventDefault();
            showMore();
          });
        }
      }
      function showMore() {
        $.ajax({
          type: "GET",
          url: link,
          data: {
            apitoken: localStorage.getItem("token"),
          },
          dataType: "JSON",
          success: function (res) {
            const brands = res.brands;
            const categrories = res.categrories;
            const products = res.products.data;
            if (brands.length > 0) {
              var str = ``;
              brands.forEach((el) => {
                str +=
                  `
                                <li><a class="dropdown-item" href="brands.html?id=` +
                  el.id +
                  `">` +
                  el.name +
                  `</a></li>
                                `;
              });
              $("#brandUl").html(str);
            }
            if (categrories.length > 0) {
              var str = ``;
              categrories.forEach((el) => {
                str +=
                  `
                                <li><a class="dropdown-item" href="categories.html?id=` +
                  el.id +
                  `">` +
                  el.name +
                  `</a></li>
                                `;
              });
              $("#cateUl").html(str);
            }

            if (products.length > 0) {
              var str = ``;
              products.forEach((el) => {
                str +=
                  `
                                <div class="col-md-3 mb-3">
                                    <div class="card" style="width: 100%;">
                                        <img class="productImage"  src="https://students.trungthanhweb.com/images/` +
                  el["images"] +
                  `">
                                        <div class="card-body">
                                            <a href="#">
                                            <h5 class="card-title">` +
                  el.name +
                  `</h5></a>
                                            <p class="card-text">
                                                Giá : ` +
                  Intl.NumberFormat("en-US").format(el.price) +
                  `    
                                            </p>
                                            <p>Loại sản phẩm : ` +
                  el.catename +
                  `</p>
                                            <p>Thương hiệu : ` +
                  el.brandname +
                  `</p>
                                            <a href="detail.html?id=` +
                  el.id +
                  `" class="btn btn-primary chitietBtn"
                                            data-id="` +
                  el.id +
                  `">Chi tiết</a>
                                            <button class="btn btn-success addToCartBtn" data-id=` +
                  el.id +
                  `>Thêm</button>
                                        </div>
                                    </div>
                                </div>
                                `;
              });
              $("#resultProduct").append(str);
              if (res.products.next_page_url != null) {
                link = res.products.next_page_url;
              } else {
                $("#showmorebtn").hide();
              }
              addToCart();
            }
          },
        });
      }
      function addToCart() {
        if (
          !localStorage.getItem("cart") ||
          localStorage.getItem("cart") == null
        ) {
          var arr = [];
        } else {
          var cart = localStorage.getItem("cart");
          var arr = JSON.parse(cart);
        }

        $(".addToCartBtn").click(function (e) {
          e.preventDefault();
          var id = Number($(this).attr("data-id"));
          var qty = 1;
          var item = [id, qty];
          var check = 0;
          arr.forEach((el) => {
            if (el[0] == id) {
              el[1]++;
              check = 1;
            }
          });
          if (check == 0) {
            arr.push(item);
          }
          localStorage.setItem("cart", JSON.stringify(arr));
          Toast.fire({
            icon: "success",
            title: "Đã thêm thành công",
          });
        });
      }
    </script>
  </body>
</html>
